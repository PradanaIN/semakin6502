import{c as Pe,u as Me,R as m,a as Ce,e as Te,r as s,b,j as a}from"./index-D7Gl0_T6.js";import{s as se,h as ne,a as Fe,b as De}from"./alerts-CR3Rk7UZ.js";import{S as ie,s as re}from"./selectStyles-C5tV3s75.js";import{S as Ee}from"./StatusBadge-CQRCyh8P.js";import{S as Ae,D as Be,a as Le,P as Ke,M as Re}from"./DataTable-CaHLHuME.js";import{u as He}from"./useModalForm-CpQE81NR.js";import{B as I}from"./Button-C-tWVwjP.js";import{L as P,I as le}from"./Label-C4PoBDXP.js";import{M as Oe,E as Ue}from"./EmptyState-BMKZPSOW.js";import{m as oe}from"./months-C0Ia_Adi.js";import{g as ze}from"./dateUtils-51te1x9i.js";import{T as de}from"./TableSkeleton-DKWwMdv2.js";import{S as L}from"./status-CiN_pTIP.js";import{E as $e}from"./eye-COv3UlrN.js";import{m as ce,A as qe}from"./proxy-BYVAC0Rh.js";import{P as Ge}from"./plus-GSDzPrJa.js";import"./confirmAlert-BWqzQj7I.js";import"./defineProperty-DRmM3rRU.js";import"./typeof-QjJsDpFa.js";import"./arrow-up-_j-HJsFD.js";import"./ChevronUpDownIcon-D0B7vQZy.js";import"./transition-Z_VUYpEE.js";import"./Skeleton-DH50fE3Q.js";/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ve=[["path",{d:"M21 10.656V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h12.344",key:"2acyp4"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]],We=Pe("square-check-big",Ve),_e=["Ayu Pinta Gabina Siregar","Elly Astutik"];function Ye(n,o){const y=r=>r.tahun*1e4+parseInt(r.bulan,10)*100+r.minggu;return[...n].sort((r,j)=>{if(r.status===L.BELUM&&j.status!==L.BELUM)return-1;if(j.status===L.BELUM&&r.status!==L.BELUM)return 1;const F=y(j)-y(r);if(F!==0)return F;const D=o&&r.kegiatan?.teamId===o,E=o&&j.kegiatan?.teamId===o;return D&&!E?-1:E&&!D?1:0})}const Xe=()=>ze(new Date);function ja(){const{user:n}=Me(),o=[m.ADMIN,m.KETUA].includes(n?.role),y=Ce(),r=Te(),[j,F]=s.useState([]),[D,E]=s.useState([]),[A,ue]=s.useState(""),[$,ge]=s.useState([]),[q,me]=s.useState([]),[G,V]=s.useState(!0),[W,_]=s.useState(""),{showForm:pe,form:d,setForm:w,openCreate:Y,closeForm:K,resetForm:he}=He({kegiatanId:"",pegawaiIds:[],deskripsi:"",minggu:Xe(),bulan:new Date().getMonth()+1,tahun:new Date().getFullYear()}),[R,xe]=s.useState(""),[c,fe]=s.useState(""),[u,be]=s.useState(new Date().getFullYear()),[p,S]=s.useState(""),[ye,X]=s.useState([]),[k,je]=s.useState(10),[N,M]=s.useState(1),[g,J]=s.useState("mine"),[Q,we]=s.useState(!1),[h,Z]=s.useState(!1),[ke,ve]=s.useState(!1);s.useEffect(()=>{n?.role===m.PIMPINAN&&J("all")},[n]),s.useEffect(()=>{r.state?.success&&(se("Berhasil",r.state.success),y(r.pathname,{replace:!0,state:{}}))},[r,y]);const ee=s.useMemo(()=>$.map(e=>({value:e.id,label:e.namaKegiatan})),[$]),H=s.useMemo(()=>q.filter(e=>e.role!==m.ADMIN&&e.role!==m.PIMPINAN&&!_e.includes(e.nama)).map(e=>({value:e.id,label:e.nama})),[q]),ae=s.useRef();s.useEffect(()=>{const e=async()=>{try{const t={};c&&(t.bulan=c),u&&(t.tahun=u);const x=((await b.get("/penugasan",{params:t})).data||[]).map(f=>f.minggu);if(x.length){const f=Math.max(...x);S(String(f))}}catch{}};n&&(p||e())},[c,u,n]),s.useEffect(()=>{if(!c||!u){X([]),S("");return}const e=parseInt(u,10),t=parseInt(c,10)-1,i=new Date(e,t,1),x=new Date(e,t+1,0),f=new Date(i);f.setDate(i.getDate()-(i.getDay()+6)%7);const v=[];for(let C=new Date(f);C<=x;C.setDate(C.getDate()+7))v.push(v.length+1);X(v),p&&p>v.length&&S("")},[c,u,p]);const O=s.useCallback(async()=>{if(n)try{V(!0),_("");const e={};c&&(e.bulan=c),u&&(e.tahun=u),p&&(e.minggu=p),g==="dariSaya"&&(e.creator=n?.id);const t=b.get("/penugasan",{params:e}),i=b.get("/teams").then(async l=>Array.isArray(l.data)&&l.data.length===0?b.get("/teams/member"):l);let x=o?b.get("/users"):Promise.resolve({data:[n]});const[f,v,C]=await Promise.all([t,i,x]);let T;if(n?.role===m.ADMIN)T=await b.get("/master-kegiatan?limit=1000");else if(n?.role===m.KETUA){const l=v.data[0]?.id;T=l?await b.get(`/master-kegiatan?team=${l}`):{data:{data:[]}}}else T={data:{data:[]}};F(Ye(f.data,n?.teamId)),E(v.data.filter(l=>l.namaTim!=="Admin"&&l.namaTim!=="Pimpinan")),me([...C.data].sort((l,z)=>l.nama.localeCompare(z.nama)));const Ie=T.data.data||T.data;ge([...Ie].sort((l,z)=>l.namaKegiatan.localeCompare(z.namaKegiatan)))}catch(e){_("Gagal mengambil data penugasan."),ne(e,"Gagal mengambil data penugasan")}finally{V(!1),ve(!0)}},[n,c,u,p,o,g]);s.useEffect(()=>{n&&O()},[n,c,u,p,g,o]);const Se=async()=>{if(we(!0),!d.kegiatanId||d.pegawaiIds.length===0){De("Lengkapi data","Kegiatan dan pegawai wajib dipilih");return}try{Z(!0),await b.post("/penugasan/bulk",d),K(),he(),O(),se("Berhasil","Penugasan ditambah")}catch(e){ne(e,"Gagal menyimpan penugasan")}finally{Z(!1)}},B=s.useMemo(()=>j.filter(e=>{const i=`${e.kegiatan?.namaKegiatan||""} ${e.pegawai?.nama||""}`.toLowerCase().includes(R.toLowerCase()),x=A?String(e.kegiatan?.teamId)===A:!0;return g==="mine"?i&&String(e.pegawaiId)===String(n?.id):i&&x&&String(e.pegawaiId)!==String(n?.id)}),[j,R,g,n?.id,A]),te=s.useMemo(()=>B.slice((N-1)*k,N*k),[B,N,k]),Ne=Math.ceil(B.length/k)||1,U=s.useMemo(()=>{const e=[{Header:"No",accessor:(t,i)=>(N-1)*k+i+1,disableFilters:!0},{Header:"Kegiatan",accessor:t=>t.kegiatan?.namaKegiatan||"-",disableFilters:!0},{Header:"Deskripsi",accessor:t=>t.deskripsi||"-",disableFilters:!0}];return g==="all"?e.push({Header:"Tim",accessor:t=>t.kegiatan?.team?.namaTim||"-",disableFilters:!0},{Header:"Pegawai",accessor:t=>t.pegawai?.nama||"-",disableFilters:!0}):e.push({Header:"Pegawai",accessor:t=>t.pegawai?.nama||"-",disableFilters:!0}),e.push({Header:"Minggu",accessor:"minggu",disableFilters:!0},{Header:"Bulan",accessor:t=>`${oe[(parseInt(t.bulan,10)||1)-1]} ${t.tahun}`,disableFilters:!0},{Header:"Status",accessor:"status",Cell:({row:t})=>a.jsx(Ee,{status:t.original.status}),disableFilters:!0}),g!=="all"&&e.push({Header:"Aksi",accessor:"id",Cell:({row:t})=>a.jsx(I,{onClick:()=>y(`/tugas-mingguan/${t.original.id}`),variant:"icon",icon:!0,"aria-label":"Detail",children:a.jsx($e,{size:16})}),disableFilters:!0}),e},[N,k,y,g]);return a.jsxs("div",{className:"space-y-6",children:[n?.role!==m.PIMPINAN&&a.jsx("div",{className:"flex flex-wrap gap-2",role:"tablist","aria-label":"View Tabs",children:[{id:"mine",label:"Tugas Saya"},...n?.role===m.KETUA?[{id:"dariSaya",label:"Dari Saya"}]:[],{id:"all",label:"Semua"}].map(e=>a.jsx("button",{type:"button",onClick:()=>{J(e.id),M(1)},role:"tab","aria-selected":g===e.id,className:`px-4 py-2 rounded-lg font-semibold transition-colors duration-150 ease-in-out shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 ${g===e.id?"bg-blue-600 text-white":"bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100 hover:bg-gray-300 dark:hover:bg-gray-600"}`,children:e.label},e.id))}),a.jsxs(ce.div,{initial:{opacity:0,y:-8},animate:{opacity:1,y:0},className:"flex flex-wrap justify-between items-center gap-2",children:[a.jsx("div",{className:"flex items-center gap-2 flex-wrap",children:a.jsx(Ae,{value:R,onChange:e=>{xe(e.target.value),M(1)},placeholder:"Cari penugasan...",ariaLabel:"Cari penugasan"})}),a.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[n?.role===m.PIMPINAN&&a.jsxs("select",{value:A,onChange:e=>{ue(e.target.value),M(1)},className:"cursor-pointer border border-gray-300 dark:border-gray-600 rounded-xl px-2 py-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:outline-none",children:[a.jsx("option",{value:"",children:"Semua Tim"}),D.map(e=>a.jsx("option",{value:String(e.id),children:e.namaTim},e.id))]}),a.jsx(Oe,{month:c,year:u,onMonthChange:e=>{fe(e),S("")},onYearChange:e=>{be(e),S("")}}),a.jsxs("select",{value:p,onChange:e=>S(e.target.value),className:"cursor-pointer border border-gray-300 dark:border-gray-600 rounded-xl px-2 py-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-400 dark:hover:border-blue-400 shadow-sm transition duration-150 ease-in-out",children:[a.jsx("option",{value:"",children:"Minggu"}),ye.map(e=>a.jsxs("option",{value:e,children:["Minggu ",e]},e))]}),o&&a.jsxs(I,{onClick:Y,className:"flex gap-2 items-center shadow-sm",variant:"primary",children:[a.jsx(Ge,{size:16}),a.jsx("span",{className:"hidden sm:inline",children:"Tugas Mingguan"})]})]})]}),a.jsx("div",{className:"overflow-x-auto md:overflow-x-visible min-h-[120px]",children:G?a.jsx(de,{cols:U.length}):W?a.jsxs("div",{className:"py-10 flex flex-col items-center text-red-600 dark:text-red-400",children:[a.jsx("span",{className:"mb-3 text-xl",children:"⚠️"}),a.jsx("span",{children:W}),a.jsx(I,{variant:"secondary",className:"mt-4",onClick:O,children:"Coba Lagi"})]}):te.length===0?ke&&!G?a.jsx(Ue,{message:"Belum ada penugasan untuk minggu ini",...o?{actionLabel:"Tambah Penugasan",onAction:Y}:{}}):a.jsx(de,{cols:U.length}):a.jsx(Be,{columns:U,data:te,showGlobalFilter:!1,showPagination:!1,selectable:!1})}),B.length>0&&a.jsxs("div",{className:"flex items-center justify-between mt-4 gap-2 flex-wrap",children:[a.jsx(Le,{pageSize:k,setPageSize:je,setCurrentPage:M,options:[5,10,25,50],className:"flex-1"}),a.jsx(Ke,{currentPage:N,totalPages:Ne,onPageChange:M})]}),a.jsx(qe,{children:o&&pe&&a.jsx(Re,{onClose:K,titleId:"penugasan-form-title",initialFocusRef:ae,children:a.jsxs(ce.div,{initial:{opacity:0,scale:.98},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},children:[a.jsxs("div",{className:"flex items-center justify-between mb-3",children:[a.jsx("h2",{id:"penugasan-form-title",className:"text-xl font-semibold mb-2",children:"Tambah Penugasan"}),a.jsx("p",{className:"text-xs text-red-600 dark:text-red-500",children:"* Fardu 'Ain"})]}),a.jsxs("form",{className:"space-y-2",onSubmit:e=>{e.preventDefault(),Se()},autoComplete:"off",children:[a.jsxs("div",{children:[a.jsxs(P,{htmlFor:"kegiatanId",children:["Kegiatan ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx(ie,{inputId:"kegiatanId",classNamePrefix:"react-select",className:"mb-1",styles:re,menuPortalTarget:document.body,options:ee,value:ee.find(e=>e.value===d.kegiatanId)||null,onChange:e=>w(t=>({...t,kegiatanId:e?.value||""})),placeholder:"Pilih kegiatan...",isSearchable:!0,isDisabled:h,noOptionsMessage:()=>"Tidak ditemukan."}),Q&&!d.kegiatanId&&a.jsx("span",{className:"text-xs text-red-500",children:"Kegiatan wajib dipilih"})]}),a.jsxs("div",{children:[a.jsxs(P,{htmlFor:"pegawaiIds",children:["Pegawai ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx(ie,{inputId:"pegawaiIds",isMulti:!0,classNamePrefix:"react-select",className:"mb-1",styles:re,menuPortalTarget:document.body,options:H,value:H.filter(e=>d.pegawaiIds.includes(e.value)),onChange:e=>w(t=>({...t,pegawaiIds:e?.map(i=>i.value)||[]})),placeholder:"Pilih pegawai...",isSearchable:!0,isDisabled:h,noOptionsMessage:()=>"Tidak ditemukan."}),a.jsxs(I,{type:"button",size:"xs",variant:"ghost",className:`
    flex items-center gap-1
    text-blue-600 hover:bg-blue-100
    dark:text-blue-400 dark:hover:bg-blue-950
    border border-gray-300 dark:border-gray-700
    rounded-md
    transition-colors duration-200
  `,onClick:()=>w(e=>({...e,pegawaiIds:H.map(t=>t.value)})),disabled:h,children:[a.jsx(We,{className:"w-4 h-4"}),"Pilih Semua"]}),Q&&d.pegawaiIds.length===0&&a.jsx("span",{className:"text-xs text-red-500",children:"Pegawai wajib dipilih"})]}),a.jsxs("div",{children:[a.jsx(P,{htmlFor:"deskripsi",children:"Deskripsi Penugasan"}),a.jsx("textarea",{id:"deskripsi",ref:ae,value:d.deskripsi,onChange:e=>w(t=>({...t,deskripsi:e.target.value})),className:"form-input resize-y w-full min-h-[48px] border rounded px-3 py-2 bg-white dark:bg-gray-700 dark:text-white",disabled:h})]}),a.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-2",children:[a.jsxs("div",{children:[a.jsxs(P,{htmlFor:"minggu",children:["Minggu ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx(le,{id:"minggu",type:"number",value:d.minggu,min:"1",max:"6",onChange:e=>w(t=>({...t,minggu:parseInt(e.target.value,10)})),className:"w-full border rounded px-3 py-2 bg-white dark:bg-gray-700 dark:text-white",disabled:h})]}),a.jsxs("div",{children:[a.jsxs(P,{htmlFor:"bulan",children:["Bulan ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx("select",{id:"bulan",value:d.bulan,onChange:e=>w(t=>({...t,bulan:parseInt(e.target.value,10)})),className:"w-full border rounded px-3 py-2 bg-white dark:bg-gray-700",disabled:h,children:oe.map((e,t)=>a.jsx("option",{value:t+1,children:e},t+1))})]}),a.jsxs("div",{children:[a.jsxs(P,{htmlFor:"tahun",children:["Tahun ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx(le,{id:"tahun",type:"number",value:d.tahun,onChange:e=>w(t=>({...t,tahun:parseInt(e.target.value,10)})),className:"w-full border rounded px-3 py-2 bg-white dark:bg-gray-700 dark:text-white",disabled:h})]})]}),a.jsxs("div",{className:"flex justify-end space-x-2 pt-2",children:[a.jsx(I,{variant:"secondary",type:"button",onClick:async()=>{(await Fe("Batalkan penambahan penugasan?")).isConfirmed&&K()},disabled:h,children:"Batal"}),a.jsx(I,{type:"submit",variant:"primary",loading:h,children:"Simpan"})]})]})]})})})]})}export{ja as default};
