import{r as n,a as le,e as oe,u as de,R as g,j as a,b as j}from"./index-D7Gl0_T6.js";import{s as _,h as H,a as ce,b as ue}from"./alerts-CR3Rk7UZ.js";import{S as me,D as ge,M as he}from"./DataTable-CaHLHuME.js";import{B as E}from"./Button-C-tWVwjP.js";import{L as I,I as X}from"./Label-C4PoBDXP.js";import{M as pe,E as xe}from"./EmptyState-BMKZPSOW.js";import{S as fe}from"./StatusBadge-CQRCyh8P.js";import{T as be}from"./Textarea-BKDpVSqP.js";import{S}from"./status-CiN_pTIP.js";import{T as je}from"./TableSkeleton-DKWwMdv2.js";import{m as J}from"./months-C0Ia_Adi.js";import{g as U}from"./dateUtils-51te1x9i.js";import{E as ke}from"./eye-COv3UlrN.js";import{P as ye}from"./plus-GSDzPrJa.js";import"./confirmAlert-BWqzQj7I.js";import"./arrow-up-_j-HJsFD.js";import"./ChevronUpDownIcon-D0B7vQZy.js";import"./transition-Z_VUYpEE.js";import"./Skeleton-DH50fE3Q.js";function ve(k,d){return[...k].sort((l,o)=>{if(l.status===S.BELUM&&o.status!==S.BELUM)return-1;if(o.status===S.BELUM&&l.status!==S.BELUM)return 1;const r=new Date(o.tanggal)-new Date(l.tanggal);if(r!==0)return r;const h=d&&String(l.teamId)===String(d),y=d&&String(o.teamId)===String(d);return h&&!y?-1:y&&!h?1:0})}const Q=()=>U(new Date);function we(k,d,l){const o=d-1,h=(new Date(l,o,1).getDay()+6)%7,y=new Date(l,o+1,0).getDate(),v=(k-1)*7-h+1,D=Math.min(y,Math.max(1,v)),P=l,B=String(d).padStart(2,"0"),p=String(D).padStart(2,"0");return`${P}-${B}-${p}`}function We(){const[k,d]=n.useState([]),[l,o]=n.useState(!0),[r,h]=n.useState(!1),[y,v]=n.useState(!1),[D,P]=n.useState([]),[B,p]=n.useState([]),[s,x]=n.useState({teamId:"",kegiatanId:"",minggu:Q(),bulan:new Date().getMonth()+1,tahun:new Date().getFullYear(),deskripsi:"",status:S.BELUM,capaianKegiatan:""}),[L,V]=n.useState(""),[c,Z]=n.useState(""),[u,ee]=n.useState(new Date().getFullYear()),A=le(),F=oe(),{user:i}=de(),K=i?.role!==g.PIMPINAN,[f,ae]=n.useState(""),[b,T]=n.useState(""),[te,O]=n.useState([]);n.useEffect(()=>{F.state?.success&&(_("Dihapus",F.state.success),A(F.pathname,{replace:!0}))},[F,A]);const se=async e=>{if(!e){p([]);return}try{let t;i?.role===g.ADMIN?t=await j.get(`/master-kegiatan?team=${e}`):t=await j.get(`/master-kegiatan?team=${e}`,{headers:{"X-For-Tambahan":"1"}}),p(t.data.data||t.data)}catch(t){H(t,"Gagal mengambil kegiatan"),p([])}},R=async()=>{if(i)try{o(!0);const e={};f&&(e.teamId=f);const t=i?.role===g.ADMIN||i?.role===g.PIMPINAN?j.get("/tugas-tambahan/all",{params:e}):j.get("/tugas-tambahan"),[M,m,N]=await Promise.all([t,i?.role===g.ADMIN||i?.role===g.KETUA?j.get("/master-kegiatan?limit=1000"):Promise.resolve({data:[]}),j.get("/teams/all")]);d(ve(M.data,i?.teamId)),p(m.data.data||m.data),P(N.data.filter(w=>w.namaTim!=="Admin"&&w.namaTim!=="Pimpinan"))}catch(e){H(e,"Gagal mengambil data")}finally{o(!1)}};n.useEffect(()=>{i&&R()},[f,i]),n.useEffect(()=>{if(!c||!u){O([]),T("");return}const e=parseInt(u,10),t=parseInt(c,10)-1,M=new Date(e,t,1),m=new Date(e,t+1,0).getDate(),N=(M.getDay()+6)%7,w=Math.ceil((m+N)/7),C=Array.from({length:w},(G,$)=>$+1);O(C),b&&b>C.length&&T("")},[c,u,b]);const Y=()=>{x({teamId:"",kegiatanId:"",minggu:Q(),bulan:new Date().getMonth()+1,tahun:new Date().getFullYear(),status:S.BELUM,deskripsi:"",capaianKegiatan:""}),p([]),v(!0)},ne=async()=>{(await ce("Batalkan penambahan?")).isConfirmed&&v(!1)},re=async()=>{if(!s.teamId||!s.kegiatanId||!s.minggu||!s.bulan||!s.tahun||s.deskripsi.trim()===""){ue("Lengkapi data","Semua kolom wajib diisi");return}try{h(!0);const e={...s};e.tanggal=we(s.minggu,s.bulan,s.tahun),delete e.teamId,delete e.minggu,delete e.bulan,delete e.tahun,Object.keys(e).forEach(t=>{e[t]===""&&t!=="capaianKegiatan"&&delete e[t]}),await j.post("/tugas-tambahan",e),v(!1),R(),_("Berhasil","Data disimpan")}catch(e){H(e,"Gagal menyimpan")}finally{h(!1)}},ie=e=>{A(`/tugas-tambahan/${e}`)},W=n.useMemo(()=>k.filter(e=>{const M=`${e.nama} ${e.kegiatan?.team?.namaTim||""}`.toLowerCase().includes(L.toLowerCase()),m=new Date(e.tanggal),N=m.getMonth()+1,w=m.getFullYear(),C=c?N===parseInt(c,10):!0,G=u?w===parseInt(u,10):!0,$=f?String(e.teamId)===f:!0;let z=!0;return b&&c&&u&&(z=U(m)===parseInt(b,10)),M&&C&&G&&$&&z}),[k,L,c,u,f,b]),q=n.useMemo(()=>[{Header:"No",accessor:(e,t)=>t+1,disableFilters:!0},{Header:"Kegiatan",accessor:"nama",disableFilters:!0},{Header:"Deskripsi",accessor:e=>e.deskripsi||"-",disableFilters:!0},{Header:"Tim",accessor:e=>e.kegiatan.team?.namaTim||"-",disableFilters:!0},{Header:"Minggu",accessor:e=>U(new Date(e.tanggal)),disableFilters:!0},{Header:"Bulan",accessor:e=>{const t=new Date(e.tanggal);return`${J[t.getMonth()]} ${t.getFullYear()}`},disableFilters:!0},{Header:"Status",accessor:"status",Cell:({row:e})=>a.jsx(fe,{status:e.original.status}),disableFilters:!0},{Header:"Aksi",accessor:"id",Cell:({row:e})=>a.jsx(E,{onClick:()=>ie(e.original.id),variant:"icon",icon:!0,"aria-label":"Detail",children:a.jsx(ke,{size:16})}),disableFilters:!0}],[i?.role]);return a.jsxs("div",{className:"space-y-6",children:[a.jsxs("div",{className:"flex justify-between items-center flex-wrap gap-2",children:[a.jsx("div",{className:"flex items-center gap-2 flex-wrap",children:a.jsx(me,{value:L,onChange:e=>V(e.target.value),placeholder:"Cari kegiatan...",ariaLabel:"Cari kegiatan"})}),a.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[[g.ADMIN,g.PIMPINAN].includes(i?.role)&&a.jsxs("select",{value:f,onChange:e=>{ae(e.target.value)},className:"cursor-pointer border border-gray-300 dark:border-gray-600 rounded-xl px-2 py-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-400 dark:hover:border-blue-400 shadow-sm transition duration-150 ease-in-out",children:[a.jsx("option",{value:"",children:"Semua Tim"}),D.map(e=>a.jsx("option",{value:e.id,children:e.namaTim},e.id))]}),a.jsx(pe,{month:c,year:u,onMonthChange:e=>{Z(e),T("")},onYearChange:e=>{ee(e),T("")}}),a.jsxs("select",{value:b,onChange:e=>T(e.target.value),className:"cursor-pointer border border-gray-300 dark:border-gray-600 rounded-xl px-2 py-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-400 dark:hover:border-blue-400 shadow-sm transition duration-150 ease-in-out",children:[a.jsx("option",{value:"",children:"Minggu"}),te.map(e=>a.jsxs("option",{value:e,children:["Minggu ",e]},e))]}),K&&a.jsxs(E,{onClick:Y,className:"add-button",children:[a.jsx(ye,{size:16}),a.jsx("span",{className:"hidden sm:inline",children:"Tugas Tambahan"})]})]})]}),a.jsx("div",{className:"overflow-x-auto md:overflow-x-visible min-h-[120px]",children:l?a.jsx(je,{cols:q.length}):W.length===0?a.jsx(xe,{message:"Belum ada tugas tambahan untuk periode ini",...K?{actionLabel:"Tambah Tugas Tambahan",onAction:Y}:{}}):a.jsx(ge,{columns:q,data:W,showGlobalFilter:!1,showPagination:!0,selectable:!1})}),K&&y&&a.jsxs(he,{onClose:()=>v(!1),titleId:"tugas-tambahan-modal-title",children:[a.jsxs("div",{className:"mb-4 flex items-center justify-between",children:[a.jsx("h2",{id:"tugas-tambahan-modal-title",className:"text-xl font-semibold",children:"Tambah Tugas Tambahan"}),a.jsx("p",{className:"text-xs text-red-600 dark:text-red-500",children:"* Wajib diisi"})]}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{children:[a.jsxs(I,{htmlFor:"teamId",children:["Tim ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsxs("select",{id:"teamId",value:s.teamId,onChange:e=>{const t=e.target.value;x({...s,teamId:t,kegiatanId:""}),se(t)},required:!0,disabled:r,className:"w-full border rounded px-3 py-2 bg-white text-gray-900 dark:bg-gray-700 dark:text-gray-200",children:[a.jsx("option",{value:"",children:"Pilih Tim"}),D.filter(e=>e.namaTim!=="Pimpinan").map(e=>a.jsx("option",{value:e.id,children:e.namaTim},e.id))]})]}),a.jsxs("div",{children:[a.jsxs(I,{htmlFor:"kegiatanId",children:["Kegiatan ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsxs("select",{id:"kegiatanId",value:s.kegiatanId,onChange:e=>x({...s,kegiatanId:e.target.value}),disabled:!s.teamId||r,required:!0,className:"w-full border rounded px-3 py-2 bg-white text-gray-900 dark:bg-gray-700 dark:text-gray-200",children:[a.jsx("option",{value:"",children:s.teamId?"Pilih Kegiatan":"Pilih Tim terlebih dahulu"}),B.map(e=>a.jsx("option",{value:e.id,children:e.namaKegiatan},e.id))]})]}),a.jsxs("div",{children:[a.jsxs(I,{htmlFor:"deskripsi",children:["Deskripsi Kegiatan ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx(be,{id:"deskripsi",value:s.deskripsi,onChange:e=>x({...s,deskripsi:e.target.value}),placeholder:"Deskripsi kegiatan...",disabled:r,required:!0})]}),a.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-2",children:[a.jsxs("div",{children:[a.jsxs(I,{htmlFor:"minggu",children:["Minggu ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx(X,{id:"minggu",type:"number",min:"1",max:"6",value:s.minggu,onChange:e=>x({...s,minggu:parseInt(e.target.value,10)}),disabled:r})]}),a.jsxs("div",{children:[a.jsxs(I,{htmlFor:"bulan",children:["Bulan ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx("select",{id:"bulan",value:s.bulan,onChange:e=>x({...s,bulan:parseInt(e.target.value,10)}),disabled:r,className:"w-full border rounded px-3 py-2 bg-white text-gray-900 dark:bg-gray-700 dark:text-gray-200",children:J.map((e,t)=>a.jsx("option",{value:t+1,children:e},t+1))})]}),a.jsxs("div",{children:[a.jsxs(I,{htmlFor:"tahun",children:["Tahun ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx(X,{id:"tahun",type:"number",value:s.tahun,onChange:e=>x({...s,tahun:parseInt(e.target.value,10)}),disabled:r})]})]}),a.jsxs("div",{className:"flex justify-end gap-3 pt-4",children:[a.jsx(E,{variant:"secondary",onClick:ne,disabled:r,children:"Batal"}),a.jsx(E,{onClick:re,loading:r,children:"Simpan"})]})]})]})]})}export{We as default};
