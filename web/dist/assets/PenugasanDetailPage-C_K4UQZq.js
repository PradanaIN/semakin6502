import{h as da,a as oa,u as ca,r,R as x,b as g,j as a,L as ga}from"./index-D7Gl0_T6.js";import{h as v,a as _,s as S,b as K,c as G,d as ua}from"./alerts-CR3Rk7UZ.js";import{S as U,s as z}from"./selectStyles-C5tV3s75.js";import{S as l,f as C}from"./status-CiN_pTIP.js";import{S as J}from"./StatusBadge-CQRCyh8P.js";import{D as xa,M as pa}from"./DataTable-CaHLHuME.js";import{B as p}from"./Button-C-tWVwjP.js";import{L as c,I as y}from"./Label-C4PoBDXP.js";import{T as E}from"./Textarea-BKDpVSqP.js";import{m as W}from"./months-C0Ia_Adi.js";import{f as ma}from"./formatDate-DfmPmopR.js";import{P as q,T as O}from"./trash-2-BA5DOFRD.js";import{P as ha}from"./plus-GSDzPrJa.js";import{E as ka}from"./external-link-B0ueuo5A.js";import"./confirmAlert-BWqzQj7I.js";import"./defineProperty-DRmM3rRU.js";import"./typeof-QjJsDpFa.js";import"./arrow-up-_j-HJsFD.js";function Ba(){const{id:u}=da(),V=oa(),{user:o}=ca(),[i,Y]=r.useState(null),k=[x.ADMIN,x.KETUA].includes(o?.role),A=[x.ADMIN,x.KETUA].includes(o?.role)||String(o?.id)===String(i?.pegawaiId),Q=o?.role===x.ADMIN||o?.role===x.KETUA||String(o?.id)===String(i?.pegawaiId),[D,F]=r.useState([]),[T,M]=r.useState([]),[n,m]=r.useState({kegiatanId:"",pegawaiId:"",deskripsi:"",minggu:1,bulan:1,tahun:new Date().getFullYear(),status:l.BELUM}),[B,N]=r.useState(!1),[X,I]=r.useState([]),[Z,j]=r.useState(!1),[t,h]=r.useState({tanggal:new Date().toISOString().slice(0,10),deskripsi:"",capaianKegiatan:"",status:l.BELUM,catatan:"",buktiLink:""}),[P,L]=r.useState(!1),aa=r.useCallback(()=>{j(!1)},[]),H=r.useRef(null),f=r.useCallback(async()=>{try{const e=await g.get(`/penugasan/${u}`),s={...e.data,kegiatanId:String(e.data.kegiatanId),pegawaiId:String(e.data.pegawaiId),bulan:parseInt(e.data.bulan,10)||1};Y(s),m({kegiatanId:s.kegiatanId,pegawaiId:s.pegawaiId,deskripsi:e.data.deskripsi||"",minggu:e.data.minggu,bulan:s.bulan,tahun:e.data.tahun,status:e.data.status})}catch(e){v(e,"Gagal mengambil data")}},[u]);r.useEffect(()=>{f(),g.get(`/laporan-harian/penugasan/${u}`).then(e=>I(e.data)),k?g.get("/users").then(e=>{const s=[...e.data].sort((d,b)=>d.nama.localeCompare(b.nama));M(s)}):o&&M([o])},[u,k,o,f]),r.useEffect(()=>{if(!k)return;(async()=>{try{let s="/master-kegiatan?limit=1000";if(o?.role!==x.ADMIN){const w=i?.kegiatan?.teamId||o?.teamId;if(!w){F([]);return}s=`/master-kegiatan?team=${w}`}const d=await g.get(s),ra=[...d.data.data||d.data].sort((w,la)=>w.namaKegiatan.localeCompare(la.namaKegiatan));F(ra)}catch{}})()},[k,o,i]);const ea=async()=>{try{await g.put(`/penugasan/${u}`,n),S("Berhasil","Penugasan diperbarui"),N(!1),f()}catch(e){v(e,"Gagal memperbarui")}},sa=()=>{h({tanggal:new Date().toISOString().slice(0,10),deskripsi:"",capaianKegiatan:"",status:l.BELUM,catatan:"",buktiLink:""}),L(!1),j(!0)},ta=async()=>{if(!P){L(!0);try{if(t.deskripsi.trim()===""){K("Lengkapi data","Deskripsi Kegiatan wajib diisi");return}if(t.capaianKegiatan.trim()===""){K("Lengkapi data","Capaian Kegiatan wajib diisi");return}if((t.status===l.SEDANG_DIKERJAKAN||t.status===l.SELESAI_DIKERJAKAN)&&!(typeof t.buktiLink=="string"?t.buktiLink:"").trim()){K("Lengkapi data","Link bukti wajib diisi");return}const{id:e,...s}=t,d={...s,buktiLink:s.buktiLink||"",catatan:s.catatan||""};e?await g.put(`/laporan-harian/${e}`,d):await g.post("/laporan-harian",{...d,penugasanId:u,pegawaiId:i.pegawaiId}),S("Berhasil","Laporan disimpan"),j(!1),setTimeout(async()=>{const b=await g.get(`/laporan-harian/penugasan/${u}`);I(b.data),f()},200)}catch(e){console.error("Failed to save report",e?.response?.data||e),e?.response?.status>=500&&console.error(e.response),v(e,"Gagal menyimpan laporan")}finally{L(!1)}}},R=e=>{h({id:e.id,tanggal:e.tanggal.slice(0,10),deskripsi:e.deskripsi||"",capaianKegiatan:e.capaianKegiatan||"",status:e.status,catatan:e.catatan??"",buktiLink:e.buktiLink??""}),j(!0)},$=async e=>{if((await G("Hapus laporan ini?")).isConfirmed)try{await g.delete(`/laporan-harian/${e}`);const d=await g.get(`/laporan-harian/penugasan/${u}`);I(d.data),f(),S("Dihapus","Laporan dihapus")}catch(d){v(d,"Gagal menghapus laporan")}},ia=r.useMemo(()=>{const e=[{Header:"No",accessor:(s,d)=>d+1,disableFilters:!0},{Header:"Deskripsi Kegiatan",accessor:"deskripsi",disableFilters:!0},{Header:"Capaian Kegiatan",accessor:"capaianKegiatan",disableFilters:!0},{Header:"Tanggal",accessor:s=>ma(s.tanggal),disableFilters:!0},{Header:"Status",accessor:"status",Cell:({row:s})=>a.jsx(J,{status:s.original.status}),disableFilters:!0},{Header:"Bukti",accessor:"buktiLink",Cell:({row:s})=>s.original.buktiLink?a.jsx("a",{href:s.original.buktiLink,target:"_blank",rel:"noreferrer","aria-label":"Lihat bukti dukung",children:a.jsx(ka,{size:16,className:"mx-auto text-blue-600 dark:text-blue-400 hover:scale-110 transition-transform"})}):"-",disableFilters:!0},{Header:"Catatan",accessor:s=>s.catatan||"-",disableFilters:!0}];return A&&e.push({Header:"Aksi",accessor:"id",Cell:({row:s})=>a.jsxs("div",{className:"space-x-2",children:[a.jsx(p,{onClick:()=>R(s.original),variant:"warning",icon:!0,"aria-label":"Edit laporan",children:a.jsx(q,{size:14})}),a.jsx(p,{onClick:()=>$(s.original.id),variant:"danger",icon:!0,"aria-label":"Hapus laporan",children:a.jsx(O,{size:14})})]}),disableFilters:!0}),e},[R,$,A]),na=async()=>{if((await G("Hapus penugasan ini?")).isConfirmed)try{await g.delete(`/penugasan/${u}`,{suppressToast:!0}),V("/tugas-mingguan",{state:{success:"Penugasan dihapus"}})}catch(s){s?.response?.status===403?ua("Tidak diizinkan","Hanya admin atau ketua tim yang dapat menghapus penugasan."):v(s,"Gagal menghapus penugasan")}};return i?a.jsxs("div",{className:"p-3 space-y-4",children:[a.jsxs("div",{className:"flex justify-between items-center",children:[a.jsx("h2",{className:"text-xl font-semibold",children:"Detail Penugasan"}),k&&!B&&a.jsxs("div",{className:"space-x-2",children:[a.jsx(p,{onClick:()=>N(!0),variant:"warning",icon:!0,"aria-label":"Edit",children:a.jsx(q,{size:16})}),a.jsx(p,{onClick:na,variant:"danger",icon:!0,"aria-label":"Hapus",children:a.jsx(O,{size:16})})]})]}),B?a.jsxs("div",{className:"space-y-2 bg-white dark:bg-gray-800 p-4 rounded-lg shadow",children:[a.jsxs("div",{className:"flex items-center justify-between mb-3",children:[a.jsx("h2",{className:"text-lg font-semibold text-gray-800 dark:text-gray-100",children:"Edit Penugasan"}),a.jsx("p",{className:"text-xs text-red-600 dark:text-red-500",children:"* Fardu 'Ain"})]}),a.jsxs("div",{children:[a.jsxs(c,{htmlFor:"kegiatan",children:["Kegiatan ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx(U,{inputId:"kegiatan",classNamePrefix:"react-select",styles:z,menuPortalTarget:document.body,options:D.map(e=>({value:String(e.id),label:e.namaKegiatan})),value:n.kegiatanId?{value:n.kegiatanId,label:D.find(e=>String(e.id)===String(n.kegiatanId))?.namaKegiatan||""}:null,onChange:e=>m({...n,kegiatanId:e?e.value:""}),isSearchable:!0})]}),a.jsxs("div",{children:[a.jsxs(c,{htmlFor:"pegawai",children:["Pegawai ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx(U,{inputId:"pegawai",classNamePrefix:"react-select",styles:z,menuPortalTarget:document.body,options:T.filter(e=>e.role!==x.ADMIN&&e.role!==x.PIMPINAN).map(e=>({value:String(e.id),label:e.nama})),value:n.pegawaiId?{value:n.pegawaiId,label:T.find(e=>String(e.id)===String(n.pegawaiId))?.nama||""}:null,onChange:e=>m({...n,pegawaiId:e?e.value:""}),isSearchable:!0})]}),a.jsxs("div",{children:[a.jsx(c,{htmlFor:"deskripsi",children:"Deskripsi Penugasan"}),a.jsx("textarea",{id:"deskripsi",value:n.deskripsi,onChange:e=>m({...n,deskripsi:e.target.value}),className:"form-input"})]}),a.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[a.jsxs("div",{children:[a.jsxs(c,{htmlFor:"minggu",children:["Minggu ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx(y,{id:"minggu",type:"number",value:n.minggu,min:"1",max:"5",onChange:e=>m({...n,minggu:parseInt(e.target.value,10)}),className:"w-full border rounded px-3 py-2 bg-white dark:bg-gray-700 dark:text-white"})]}),a.jsxs("div",{children:[a.jsxs(c,{htmlFor:"bulan",children:["Bulan ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx("select",{id:"bulan",value:n.bulan,onChange:e=>m({...n,bulan:parseInt(e.target.value,10)}),className:"w-full border rounded px-3 py-2 bg-white dark:bg-gray-700 dark:text-white",children:W.map((e,s)=>a.jsx("option",{value:s+1,children:e},s+1))})]}),a.jsxs("div",{children:[a.jsxs(c,{htmlFor:"tahun",children:["Tahun ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx(y,{id:"tahun",type:"number",value:n.tahun,onChange:e=>m({...n,tahun:parseInt(e.target.value,10)}),className:"w-full border rounded px-3 py-2 bg-white dark:bg-gray-700 dark:text-white"})]})]}),a.jsxs("div",{className:"flex justify-end space-x-2 pt-2",children:[a.jsx(p,{variant:"secondary",onClick:async()=>{(await _("Batalkan perubahan?")).isConfirmed&&(m({kegiatanId:i.kegiatanId,pegawaiId:i.pegawaiId,deskripsi:i.deskripsi||"",minggu:i.minggu,bulan:i.bulan,tahun:i.tahun,status:i.status}),N(!1))},children:"Batal"}),a.jsx(p,{onClick:ea,children:"Simpan"})]})]}):a.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 sm:gap-3 lg:gap-4 bg-white dark:bg-gray-800 p-3 sm:p-4 rounded-lg shadow",children:[a.jsxs("div",{children:[a.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 inline-flex items-center gap-1",children:[a.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"14",height:"14",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"text-gray-400",children:[a.jsx("rect",{x:"8",y:"2",width:"8",height:"4",rx:"1",ry:"1"}),a.jsx("path",{d:"M16 4h1a3 3 0 0 1 3 3v12a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V7a3 3 0 0 1 3-3h1"}),a.jsx("line",{x1:"9",y1:"12",x2:"15",y2:"12"}),a.jsx("line",{x1:"9",y1:"16",x2:"15",y2:"16"})]}),"Kegiatan"]}),a.jsx("div",{className:"font-medium",children:i.kegiatan?.namaKegiatan})]}),a.jsxs("div",{className:"sm:col-span-2 lg:col-span-3",children:[a.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 inline-flex items-center gap-1",children:[a.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"14",height:"14",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"text-gray-400",children:[a.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),a.jsx("polyline",{points:"14 2 14 8 20 8"}),a.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),a.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"})]}),"Deskripsi Penugasan"]}),a.jsx("div",{className:"font-medium",children:i.deskripsi||"-"})]}),a.jsxs("div",{children:[a.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 inline-flex items-center gap-1",children:[a.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"14",height:"14",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"text-gray-400",children:[a.jsx("path",{d:"M17 21v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2"}),a.jsx("circle",{cx:"9",cy:"7",r:"4"}),a.jsx("path",{d:"M23 21v-2a4 4 0 0 0-3-3.87"}),a.jsx("path",{d:"M16 3.13a4 4 0 0 1 0 7.75"})]}),"Tim"]}),a.jsx("div",{className:"font-medium",children:i.kegiatan?.team?.namaTim})]}),a.jsxs("div",{children:[a.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 inline-flex items-center gap-1",children:[a.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"14",height:"14",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"text-gray-400",children:[a.jsx("path",{d:"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"}),a.jsx("circle",{cx:"12",cy:"7",r:"4"})]}),"Pegawai"]}),a.jsx("div",{className:"font-medium",children:i.pegawai?.nama})]}),a.jsxs("div",{children:[a.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 inline-flex items-center gap-1",children:[a.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"14",height:"14",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"text-gray-400",children:[a.jsx("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2",ry:"2"}),a.jsx("line",{x1:"16",y1:"2",x2:"16",y2:"6"}),a.jsx("line",{x1:"8",y1:"2",x2:"8",y2:"6"}),a.jsx("line",{x1:"3",y1:"10",x2:"21",y2:"10"})]}),"Waktu"]}),a.jsx("div",{className:"font-medium",children:`Minggu ${i.minggu} • ${W[i.bulan-1]} ${i.tahun}`})]}),a.jsxs("div",{children:[a.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 inline-flex items-center gap-1",children:[a.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"12",height:"12",fill:"currentColor",className:"text-gray-400",children:a.jsx("circle",{cx:"12",cy:"12",r:"5"})}),"Status"]}),a.jsx("div",{className:"font-medium",children:a.jsx(J,{status:i.status})})]})]}),a.jsxs("div",{className:"space-y-4 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md",children:[a.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-2",children:[a.jsx("h3",{className:"text-xl font-bold text-gray-800 dark:text-gray-100",children:"Laporan Harian"}),i.status!==l.SELESAI_DIKERJAKAN&&Q&&a.jsxs(p,{onClick:sa,className:"flex items-center gap-2 px-3 py-2 sm:px-4","aria-label":"Tambah Laporan",children:[a.jsx(ha,{size:18}),a.jsx("span",{className:"hidden sm:inline",children:"Tambah Laporan"})]})]}),a.jsx("div",{className:"overflow-x-auto md:overflow-x-visible rounded-lg border dark:border-gray-700",children:a.jsx(xa,{columns:ia,data:X,showGlobalFilter:!1,showPagination:!1,selectable:!1})})]}),Z&&a.jsx(pa,{onClose:aa,titleId:"laporan-form-title",children:a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("h3",{id:"laporan-form-title",className:"text-lg font-semibold text-gray-800 dark:text-gray-100",children:[t.id?"Edit":"Tambah"," Laporan Harian"]}),a.jsx("span",{className:"text-xs text-red-500",children:"* Fardu 'Ain"})]}),a.jsxs("form",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[a.jsxs("div",{className:"col-span-1 md:col-span-2",children:[a.jsxs(c,{htmlFor:"laporanDeskripsi",children:["Deskripsi Kegiatan ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx(E,{id:"laporanDeskripsi",value:t.deskripsi,onChange:e=>h({...t,deskripsi:e.target.value}),placeholder:"Tuliskan deskripsi kegiatan...",required:!0})]}),a.jsxs("div",{className:"col-span-1 md:col-span-2",children:[a.jsxs(c,{htmlFor:"capaianKegiatan",children:["Capaian Kegiatan ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx(E,{id:"capaianKegiatan",value:t.capaianKegiatan,onChange:e=>h({...t,capaianKegiatan:e.target.value}),placeholder:"Tuliskan capaian kegiatan...",required:!0})]}),a.jsxs("div",{children:[a.jsxs(c,{htmlFor:"laporanTanggal",children:["Tanggal ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx(y,{id:"laporanTanggal",type:"date",ref:H,value:t.tanggal,onChange:e=>h({...t,tanggal:e.target.value}),onFocus:()=>H.current?.showPicker(),required:!0})]}),a.jsxs("div",{children:[a.jsxs(c,{htmlFor:"laporanStatus",children:["Status ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsxs("select",{id:"laporanStatus",value:t.status,onChange:e=>h({...t,status:e.target.value}),required:!0,className:"w-full rounded-md border px-3 py-2 bg-white dark:bg-gray-700 dark:text-white",children:[a.jsx("option",{value:l.BELUM,children:C(l.BELUM)}),a.jsx("option",{value:l.SEDANG_DIKERJAKAN,children:C(l.SEDANG_DIKERJAKAN)}),a.jsx("option",{value:l.SELESAI_DIKERJAKAN,children:C(l.SELESAI_DIKERJAKAN)})]})]}),(t.status===l.SEDANG_DIKERJAKAN||t.status===l.SELESAI_DIKERJAKAN)&&a.jsxs("div",{className:"col-span-1 md:col-span-2",children:[a.jsxs(c,{htmlFor:"buktiLink",children:["Link Bukti ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx(y,{id:"buktiLink",type:"url",value:t.buktiLink,onChange:e=>h({...t,buktiLink:e.target.value}),placeholder:"https://...",required:!0})]}),a.jsxs("details",{className:"col-span-1 md:col-span-2 mt-2",children:[a.jsx("summary",{className:"cursor-pointer text-sm text-blue-600 dark:text-blue-400",children:"Tambah Catatan Kendala (Opsional)"}),a.jsxs("div",{className:"mt-2",children:[a.jsx(c,{htmlFor:"catatan",children:"Catatan"}),a.jsx(E,{id:"catatan",value:t.catatan,onChange:e=>h({...t,catatan:e.target.value}),placeholder:"Catatan kendala..."})]})]})]}),a.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[a.jsx(p,{variant:"secondary",onClick:async()=>{(await _(t.id?"Batalkan perubahan?":"Batalkan penambahan laporan?")).isConfirmed&&j(!1)},children:"Batal"}),a.jsx(p,{type:"button",onClick:ta,disabled:P,children:"Simpan"})]})]})})]}):a.jsx(ga,{fullScreen:!0})}export{Ba as default};
